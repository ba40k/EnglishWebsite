{% extends "base.html" %}

{% block title %}{{ article.title }} - English Learning Platform{% endblock %}

{% block content %}
<div class="content-card">
  <h1>{{ article.title }}</h1>
  <div class="card-meta" style="margin-bottom: 2rem;">
    <span>‚úçÔ∏è {{ article.author }}</span>
    <span>‚Ä¢</span>
    <span>{{ article.created_at.strftime('%B %d, %Y at %I:%M %p') if article.created_at else 'Recently' }}</span>
  </div>
  
  <div style="font-size: 1.1rem; line-height: 1.8; color: var(--dark);">
    {{ article.body | safe }}
  </div>

  {% if ai_summary or ai_vocabulary %}
  <div class="ai-summary">
    <h3>ü§ñ AI Learning Assistant</h3>
    
    {% if ai_summary %}
    <div style="margin: 1rem 0;">
      <h4>üìã Summary</h4>
      <p style="line-height: 1.8;">{{ ai_summary }}</p>
    </div>
    {% endif %}
    
    {% if ai_vocabulary %}
    <div style="margin: 1.5rem 0;">
      <h4>üìñ Key Vocabulary</h4>
      <ul class="vocabulary-list">
        {% for item in ai_vocabulary %}
          <li>
            <strong>{{ item.word }}</strong>: {{ item.definition }}
          </li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
  </div>
  {% endif %}

  <div class="ai-section">
    <h3>üí¨ Ask AI About This Article</h3>
    <p style="color: var(--gray); margin-bottom: 1rem;">Have questions? Ask AI for help understanding vocabulary, grammar, or concepts!</p>
    <form id="ask-ai-form">
      <div style="display: flex; gap: 0.5rem;">
        <input type="text" id="ai-question" placeholder="e.g., What does 'concept' mean? or Explain this paragraph..." required>
        <button type="submit" style="white-space: nowrap;">Ask AI</button>
      </div>
    </form>
    <div id="ai-answer" style="display: none;">
      <strong>ü§ñ AI Answer:</strong>
      <p id="ai-answer-text" style="margin-top: 0.5rem; line-height: 1.7;"></p>
    </div>
  </div>

  <script>
    document.getElementById('ask-ai-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const question = document.getElementById('ai-question').value;
      const answerDiv = document.getElementById('ai-answer');
      const answerText = document.getElementById('ai-answer-text');
      
      answerDiv.style.display = 'block';
      answerText.innerHTML = '<em class="loading">ü§î Thinking...</em>';
      
      try {
        const formData = new FormData();
        formData.append('question', question);
        
        const response = await fetch('/articles/{{ article.id }}/ask-ai', {
          method: 'POST',
          body: formData
        });
        
        const data = await response.json();
        answerText.textContent = data.answer || 'No answer received.';
      } catch (error) {
        answerText.innerHTML = '<span style="color: var(--danger);">‚ùå Error: Could not get an answer.</span>';
      }
    });
  </script>

  <div class="comments-section">
    <h3>üí¨ Comments</h3>
    
    {% if article.comments %}
      <div style="margin: 1.5rem 0;">
        {% for c in article.comments %}
          <div class="comment">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
              <span class="comment-author">{{ c.author }}</span>
              <span class="comment-time">{{ c.created_at.strftime('%b %d, %Y') if c.created_at else 'Recently' }}</span>
            </div>
            <p style="color: var(--dark);">{{ c.text }}</p>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p style="color: var(--gray); margin: 1rem 0;">No comments yet. Be the first to comment!</p>
    {% endif %}

    <h4 style="margin-top: 2rem;">Leave a Comment</h4>
    <form action="/articles/{{ article.id }}/comments" method="post">
      <div class="form-group">
        <label for="author">Your Name</label>
        <input type="text" id="author" name="author" placeholder="Anonymous" value="Anonymous">
      </div>
      <div class="form-group">
        <label for="text">Comment</label>
        <textarea id="text" name="text" required placeholder="Share your thoughts..."></textarea>
      </div>
      <button type="submit">üí¨ Post Comment</button>
    </form>
  </div>
</div>

<div style="margin-top: 2rem; text-align: center;">
  <a href="/articles" class="btn btn-outline">‚Üê Back to Articles</a>
</div>
{% endblock %}